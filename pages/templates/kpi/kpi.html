<!-- templates/index.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}Advisory Details - Vale Dash{% endblock %}
{% block content %}

<style>
    #custom-tooltip {
        position: absolute;
        background: white;
        border: 1px solid black;
        padding: 10px;
        border-radius: 5px;
        pointer-events: auto;
        display: none;
        z-index: 1000;
    }

    .checkbox-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
    }

    .x_content {
        padding: 0 3px 0 !important;
        clear: both !important;
        margin-top: 0px !important;
    }

    .resetZoom {
        position: absolute;
        top: 8vh;
        left: 4vw;
        z-index: 10;
        cursor: pointer;
    }

    body {
        overflow: hidden;
    }

    /* Option 2: force override */
    .bg-success {
        background-color: #007e7a !important;
    }
</style>
<div class="row" id="chart_container">
    <div class="col-md-12 col-sm-12 px-0">
        <div class="x_panel" style="padding: 0;display: flex;align-items: center;justify-content: space-between;align-content: center;flex-wrap: nowrap;flex-direction: row;">
            <div style="display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                <div id="reportrange_right" class="pull-left"
                    style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;">
                    <i class="fa fa-calendar"></i>
                    <span>December 30, 2014 - January 28, 2015</span> <b class="caret"></b>
                </div>
                <div
                    style="background: #fff; cursor: pointer; padding: 5px 10px; margin-left: 5px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <div
                        style="background: #fff; cursor: pointer; padding: 5px 10px; margin-left: 5px; display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                        <!-- Group Checkboxes -->
                        <div class="form-check form-check-inline">
                            <input class="form-check-input group-checkbox" type="checkbox" id="group_Larona"
                                data-group="Larona">
                            <label class="form-check-label" for="group_Larona">Larona</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input group-checkbox" type="checkbox" id="group_Balambano"
                                data-group="Balambano">
                            <label class="form-check-label" for="group_Balambano">Balambano</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input group-checkbox" type="checkbox" id="group_Karebbe"
                                data-group="Karebbe">
                            <label class="form-check-label" for="group_Karebbe">Karebbe</label>
                        </div>

                        <!-- Individual Checkboxes -->
                        <div id="tagCheckboxes"></div>
                    </div>
                    <script>
                        const tagMap = {
                            Larona: ["LGS1", "LGS2", "LGS3"],
                            Balambano: ["BGS1", "BGS2"],
                            Karebbe: ["KGS1", "KGS2"]
                        };

                        // Hardcoded status for now
                        const tagStatus = {
                            LGS1: "chk..",
                            LGS2: "chk..",
                            LGS3: "chk..",
                            BGS1: "chk..",
                            BGS2: "chk..",
                            KGS1: "chk..",
                            KGS2: "chk.."
                        };

                        const tagContainer = document.getElementById("tagCheckboxes");

                        // Generate tag checkboxes dynamically
                        const allTags = Object.values(tagMap).flat();
                        allTags.forEach(tag => {
                            const wrapper = document.createElement("div");
                            wrapper.classList.add("form-check", "form-check-inline");

                            const status = tagStatus[tag];
                            const color = status === "alive" ? "green" : "red";

                            wrapper.innerHTML = `
                            <input class="form-check-input tag-checkbox" type="checkbox" id="tag_${tag}" value="${tag}">
                            <label class="form-check-label" for="tag_${tag}" style="color:${color}">${tag} (${status})</label>
                        `;
                            tagContainer.appendChild(wrapper);
                        });

                        const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
                        const groupCheckboxes = document.querySelectorAll('.group-checkbox');

                        function getURLTags() {
                            const params = new URLSearchParams(window.location.search);
                            const tagString = params.get("tag");
                            if (!tagString) return null;
                            return tagString.split(",");
                        }

                        function setCheckboxStatesFromURL(tagsInURL) {
                            if (!tagsInURL) {
                                tagCheckboxes.forEach(cb => cb.checked = true);
                            } else {
                                tagCheckboxes.forEach(cb => {
                                    cb.checked = tagsInURL.includes(cb.value);
                                });
                            }

                            groupCheckboxes.forEach(groupCB => {
                                const group = groupCB.dataset.group;
                                const groupTags = tagMap[group];
                                groupCB.checked = groupTags.every(tag => document.getElementById(`tag_${tag}`).checked);
                            });
                        }

                        function updateURLFromSelections() {
                            const selectedTags = Array.from(tagCheckboxes)
                                .filter(cb => cb.checked)
                                .map(cb => cb.value);

                            const params = new URLSearchParams(window.location.search);
                            if (selectedTags.length > 0) {
                                params.set("tag", selectedTags.join(","));
                            } else {
                                params.delete("tag");
                            }

                            window.location.search = params.toString();
                        }

                        function handleGroupCheckbox(groupCB) {
                            const group = groupCB.dataset.group;
                            const groupTags = tagMap[group];
                            groupTags.forEach(tag => {
                                document.getElementById(`tag_${tag}`).checked = groupCB.checked;
                            });
                            updateURLFromSelections();
                        }

                        function handleTagCheckboxChange() {
                            groupCheckboxes.forEach(groupCB => {
                                const group = groupCB.dataset.group;
                                const groupTags = tagMap[group];
                                groupCB.checked = groupTags.every(tag => document.getElementById(`tag_${tag}`).checked);
                            });
                            updateURLFromSelections();
                        }

                        // Attach listeners
                        groupCheckboxes.forEach(cb => {
                            cb.addEventListener("change", () => handleGroupCheckbox(cb));
                        });

                        tagCheckboxes.forEach(cb => {
                            cb.addEventListener("change", handleTagCheckboxChange);
                        });

                        const urlTags = getURLTags();
                        setCheckboxStatesFromURL(urlTags);
                    </script>
                </div>
            </div>
            <a class="btn btn-link" href="{% url 'kpi_manualdata' %}">Update</a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 px-0">
        <div class="x_content">
            <div class="row">
                <div class="col-lg-3 col-md-3 col-sm-6 px-0">
                    <div class="x_panel tile" style="height: 30vh;">
                        <div class="x_content" style="height: 100%; display: flex; flex-direction: column;">
                            <h2>OEE</h2>
                            <div id="gauge_oee" style="height: 70%; box-sizing: border-box;"></div>
                            <canvas id="sparkline_oee" class="sparkline" style="height: 15%; width: 100%;"></canvas>
                            <div style="height: 5%; margin-top: 5px;">
                                <p>Previously Period: <span id="prev_oee">100%</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-3 col-sm-6 px-0">
                    <div class="x_panel tile" style="height: 30vh;">
                        <div class="x_content" style="height: 100%; display: flex; flex-direction: column;">
                            <h2>Physical Availability</h2>
                            <div id="gauge_phy_avail" style="height: 70%; box-sizing: border-box;"></div>
                            <canvas id="sparkline_phy_avail" class="sparkline"
                                style="height: 15%; width: 100%;"></canvas>
                            <div style="height: 5%; margin-top: 5px;">
                                <p>Previously Period: <span id="prev_phy_avail">100%</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-3 col-sm-6 px-0">
                    <div class="x_panel tile" style="height: 30vh;">
                        <div class="x_content" style="height: 100%; display: flex; flex-direction: column;">
                            <h2>Performance</h2>
                            <div id="gauge_performance" style="height: 70%; box-sizing: border-box;"></div>
                            <canvas id="sparkline_performance" class="sparkline"
                                style="height: 15%; width: 100%;"></canvas>
                            <div style="height: 5%; margin-top: 5px;">
                                <p>Previously Period: <span id="prev_performance">100%</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-3 col-sm-6 px-0">
                    <div class="x_panel tile" style="height: 30vh;">
                        <div class="x_content" style="height: 100%; display: flex; flex-direction: column;">
                            <h2>Utilization of Availability</h2>
                            <div id="gauge_uo_Avail" style="height: 70%; box-sizing: border-box;"></div>
                            <canvas id="sparkline_uo_Avail" class="sparkline"
                                style="height: 15%; width: 100%;"></canvas>
                            <div style="height: 5%; margin-top: 5px;">
                                <p>Previously Period: <span id="prev_uo_Avail">100%</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="">
            <div class="x_content">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 px-0">
                        <div class="x_panel tile" style="height: 30vh;">
                            <div class="x_content" style="height: 100%;">
                                <h2>Power Production (<span style="text-align: center;" id="hp_total"></span>)</h2>
                                <div class="row" style="height: 78%;">
                                    <div class="col-lg-6 col-md-6 col-sm-6 px-0" style="height: 100%;">
                                        <canvas id="production_powerpie1" style="width: 100%; height: 25vh;"></canvas>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6" style="height: 100%;">
                                        <canvas id="production_trendchart" style="width: 100%; height: 22vh;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 px-0">
        <div class="x_content">
            <div class="row" id="kpiProgressBarsByMetric">
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="">
            <div class="x_content">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 px-0">
                        <div class="x_panel tile" style="height: 30vh;">
                            <div class="x_content" style="height: 100%;">
                                <h2>Grid Units</h2>
                                <div class="row" style="height: 78%;">
                                    <div class="col-lg-6 col-md-6 col-sm-6 px-0" style="height: 100%;">
                                        <canvas id="grid_pie1" style="width: 100%; height: 25vh;"></canvas>
                                    </div>
                                    <div class="col-lg-6 col-md-6 col-sm-6" style="height: 100%;">
                                        <canvas id="grid_trendchart" style="width: 100%; height: 22vh;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 col-sm-8 px-0">
        <div class="x_panel tile" style="height: 30vh;">
            <div class="x_content">
                <div style="display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <h2 style="margin: 0;">KPI Trend</h2>
                    <button type="button" onclick="resetZoom(line_chart1)"><i class="fa fa-search-minus"
                            aria-hidden="true"></i></button>
                    <form id="checkboxContainer" class="d-flex align-items-center gap-2 flex-wrap m-0 p-0"></form>
                </div>

                <div id="custom-tooltip0"
                    style=" position: absolute; background: white; border: 1px solid black; padding: 10px; border-radius: 5px; pointer-events: auto; display: none; z-index: 1000; ">
                </div>
                <canvas id="kpi_trend_chart" style="width: 100%; height: 25vh"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-4 px-0">
        <div class="x_panel tile" style="height: 30vh;">
            <div class="x_content">
                <div style="display: flex; align-items: center; gap: 10px; justify-content: space-between;">
                    <h2>Number of Event</h2>
                    <form method="get" style="margin: 0;">
                        <select id="noe_metric_select">
                            <option value="noe">Default</option>
                            <option value="duration">Duration</option>
                        </select>
                    </form>
                </div>
                <canvas id="stackedChart" style="width: 100%; height: 23vh"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const select = document.getElementById('noe_metric_select');

    // Read current GET parameters
    const params = new URLSearchParams(window.location.search);

    // Set selected option based on current noe_metric
    const currentValue = params.get('noe_metric') || 'noe';
    select.value = currentValue;

    // Update URL on change (preserve other GET params)
    select.addEventListener('change', function () {
        params.set('noe_metric', this.value);
        window.location.search = params.toString();
    });
</script>

<script>
    let end_date;
    let start_date;
    let idx_sensor;

    const datepicker_callback = function (start, end, label) {
        var url = new URL(window.location.href);
        var params = url.searchParams;

        params.set('start_date', start.format("YYYY-MM-DDTHH:mm:ss"));
        params.set('end_date', end.format("YYYY-MM-DDTHH:mm:ss"));

        window.location.href = `${url.pathname}?${params.toString()}`;
    };


    function severity2color(severity) {
        const norm = (severity - 1) / 5; // Normalize severity to range [0,1]
        const colorScale = d3.scaleLinear()
            .domain([0, 0.5, 1]) // Normalized values
            .range(["green", "yellow", "red"]); // Corresponding colors
        return colorScale(norm); // Return the mapped color
    }

    const colorPalette = [
        'red', 'blue', 'green', 'orange', 'purple', 'teal', 'gold', 'brown'
    ];

    let correlate_chart = [];
    let line_chart1;
    let line_chart2;
    let line_chart3;

    const kpi_key = ["oee", "phy_avail", "performance", "uo_Avail"]
    const kpi_labels = ["OEE", "Physical Availability", "Performance", "Utilization of Availability"]
    function getColorClassByValue(value, kpi_key_now) {
        return colors_line_chart1[kpi_key.indexOf(kpi_key_now) % colors_line_chart1.length]
        // if (value < 20) return "bg-danger";         // dark red
        // if (value < 40) return "bg-danger-subtle";  // red
        // if (value < 60) return "bg-warning";        // orange
        // if (value < 80) return "bg-warning-subtle"; // dark yellow
        // return "bg-success" // colors_line_chart1[kpi_key.indexOf(kpi_key_now) % colors_line_chart1.length];                        // green
    }

    function getColorFromValue(value, kpi_key_now) {
        return colors_line_chart1[kpi_key.indexOf(kpi_key_now) % colors_line_chart1.length]
        // const colorMap = [
        //     [0.16, '#ff0000'],
        //     [0.32, '#ff5500'],
        //     [0.48, '#ffaa00'],
        //     [0.64, '#e5e500'],
        //     [0.80, '#99e500'],
        //     [1.00, '#007e7a']
        // ];

        // for (let i = 0; i < colorMap.length; i++) {
        //     if (value <= colorMap[i][0]) {
        //         return colorMap[i][1];
        //     }
        // }
        // return colorMap[colorMap.length - 1][1];
    }

    function aggregateData(data, maxPoints = 500) {
        const n = data.length;
        if (n <= maxPoints) return data;

        const step = Math.ceil(n / maxPoints);
        const aggregated = [];
        for (let i = 0; i < n; i += step) {
            const slice = data.slice(i, i + step);
            const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
            aggregated.push(avg);
        }
        return aggregated;
    }

    var kpiDatasets = [];

    $(document).ready(function () {
        var url = new URL(window.location.href);
        var urlParams = new URLSearchParams(url.search);

        if (urlParams.has('start_date')) {
            end_date = moment.utc(urlParams.get('end_date')).format("YYYY-MM-DDTHH:mm:ss");
            start_date = moment.utc(urlParams.get('start_date')).format("YYYY-MM-DDTHH:mm:ss");
        } else {
            end_date = nowDateMoment.format("YYYY-MM-DDTHH:mm:ss");
            start_date = nowDateMoment.subtract(29, 'days').format("YYYY-MM-DDTHH:mm:ss");
        }

        $('#reportrange_right span').html(moment.utc(start_date).format('MMMM D, YYYY') + ' - ' + moment.utc(end_date).format('MMMM D, YYYY'));
        $('#reportrange_right').daterangepicker(dateRangeOptions1, datepicker_callback);


        let tags = urlParams.get('tag');
        if (!tags) {
            tags = Object.values(tagMap).flat().join(",");
        }

        let noe_metric = urlParams.get('noe_metric');
        if (!noe_metric) {
            noe_metric = "noe";
        }

        $.ajax({
            type: "GET",
            dataType: "json",
            url: "/api/unitStatus",
            data: { start_date: start_date, end_date: end_date },
            success: function (data) {
                console.log(data.status_dict)
                Object.keys(data.status_dict).forEach(tag => {
                    console.log(tag)
                    const status = data.status_dict[tag];
                    const color = status === "alive" ? "green" : "red";

                    const label = document.querySelector(`label[for='tag_${tag}']`);
                    if (label) {
                        label.textContent = `${tag} (${status})`;
                        label.style.color = color;
                    }
                });
            }
        })

        $.ajax({
            type: "GET",
            dataType: "json",
            url: "/api/kpi",
            data: { start_date: start_date, end_date: end_date, tags: tags, noe_metric: noe_metric },
            success: function (data) {
                const keysToAverage = ['oee', 'phy_avail', 'performance', 'uo_Avail'];
                const keys_unit = Object.keys(data).filter(key => key !== 'plant' && key !== 'noe' && key !== 'other_kpi');
                const timestamps = data[keys_unit[0]].timestamp;
                const combinedData = {
                    data_timestamp: timestamps,
                    oee: [],
                    phy_avail: [],
                    performance: [],
                    uo_Avail: [],
                };

                for (let i = 0; i < timestamps.length; i++) {
                    for (const key of keysToAverage) {
                        let sum = 0;
                        for (const unitKey of keys_unit) {
                            sum += data[unitKey][key][i];
                        }
                        const avg = sum / keys_unit.length;
                        combinedData[key].push(avg);
                    }
                }

                for (const key in combinedData) {
                    if (key === 'data_timestamp') continue;
                    combinedData[key] = combinedData[key].map(v => Math.round(v * 100) / 100);
                }

                setTimeout(() => {
                    const checkboxContainer = document.getElementById('checkboxContainer');
                    for (let index = 0; index < kpi_key.length; index++) {
                        const nowKPIKey = kpi_key[index];
                        document.getElementById("prev_" + nowKPIKey).innerHTML = Math.floor(combinedData[nowKPIKey][combinedData[nowKPIKey].length - 2] * 100) + "%";

                        const arr_kpidata = combinedData[nowKPIKey] || [];
                        const mean_kpigauge = arr_kpidata.length ? Math.floor((arr_kpidata.reduce((s, v) => s + v, 0) / arr_kpidata.length)  * 100) : 0;

                        gaugeSeverityChartOptionsKPI.series[0].data[0].value = mean_kpigauge;
                        gaugeSeverityChartOptionsKPI.series[0].itemStyle.color = getColorFromValue(mean_kpigauge, nowKPIKey);

                        gaugeSeverityChart = echarts.init(document.getElementById('gauge_' + nowKPIKey), null, {
                            renderer: 'canvas',
                        });
                        gaugeSeverityChart.setOption(gaugeSeverityChartOptionsKPI);
                        window.addEventListener('resize', gaugeSeverityChart.resize);

                        const color = colorPalette[index % colorPalette.length];
                        kpiDatasets.push({
                            label: kpi_labels[index],
                            data: combinedData[nowKPIKey].map((v, i) => v * 100),
                            borderColor: color,
                            backgroundColor: Chart.helpers.color(color).alpha(0.2).rgbString(),
                            tension: 0.4,
                            pointRadius: 0,
                        })

                        var mustCheck = "";
                        if (index == 0) {
                            mustCheck = "checked";
                        }
                        checkboxContainer.innerHTML += `<div class="form-check form-check-inline">
                                                            <input class="form-check-input" type="checkbox" name="dataset" id="chk_${index}" value="${index}" ${mustCheck}>
                                                            <label class="form-check-label" for="chk_${index}">${kpi_labels[index]}</label>
                                                        </div>`

                        const ctx1 = document.getElementById(`sparkline_${nowKPIKey}`).getContext('2d');
                        new Chart(ctx1, {
                            type: 'line',
                            data: {
                                labels: combinedData[nowKPIKey].map((_, i) => i + 1),
                                datasets: [{
                                    data: combinedData[nowKPIKey],
                                    borderColor: '#4CAF50',
                                    fill: true,
                                    borderWidth: 1,
                                    pointRadius: 0,
                                    tension: 0.3
                                }]
                            },
                            options: {
                                responsive: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { enabled: false }
                                },
                                scales: {
                                    x: { display: false },
                                    y: {
                                        display: false,
                                        min: 0,
                                        max: 1
                                    }
                                }
                            }
                        });
                    }

                    function aggregateDataWithTimestamps(data, timestamps, maxPoints = 100) {
                        const n = data.length;
                        if (n <= maxPoints) return { data, timestamps };

                        const step = Math.ceil(n / maxPoints);
                        const aggregatedData = [];
                        const aggregatedTimestamps = [];

                        for (let i = 0; i < n; i += step) {
                            const slice = data.slice(i, i + step);
                            const sliceTimestamps = timestamps.slice(i, i + step);

                            // average the data
                            const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
                            aggregatedData.push(avg);

                            // pick the first timestamp (or midpoint)
                            aggregatedTimestamps.push(sliceTimestamps[0]);
                        }

                        return { data: aggregatedData, timestamps: aggregatedTimestamps };
                    }

                    const agg = aggregateDataWithTimestamps(kpiDatasets[0].data, combinedData.data_timestamp);
                    kpiDatasets[0].data = agg.data;
                    const formattedLabels = agg.timestamps.map(ts => {
                        const d = new Date(ts);
                        return `${d.getDate().toString().padStart(2, '0')}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getFullYear()}`;
                    });
                    
                    line_chart1 = new Chart(document.getElementById(`kpi_trend_chart`).getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: formattedLabels,
                            datasets: [{
                                ...kpiDatasets[0],
                                borderColor: '#32635a',
                                backgroundColor: '#32635a'
                            }]
                        },
                        options: {
                            responsive: false,
                            scales: {
                                x: {
                                    time: {
                                        unit: 'auto',
                                        tooltipFormat: 'Do-MM-yyy',
                                        displayFormats: {
                                            millisecond: 'Do-MM-yyyy',
                                            second: 'Do-MM-yyyy',
                                            minute: 'Do-MM-yyyy',
                                            hour: 'Do-MM-yyyy',
                                            day: 'Do-MM-yyyy',
                                            week: 'Do-MM-yyyy',
                                            month: 'Do-MM-yyyy',
                                            quarter: 'Do-MM-yyyy',
                                            year: 'Do-MM-yyyy'
                                        }
                                    },
                                    ticks: {
                                        minRotation: 0,
                                        maxTicksLimit: 7,
                                        autoSkip: true,
                                    },
                                    title: {
                                        display: true,
                                        text: 'Timestamp'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: "Percentage (%)"
                                    },
                                    min: 0,
                                    max: 120
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                },
                                tooltip: {
                                    enabled: false,
                                },
                                zoom: zoomPluginsLineConfig
                            },
                        }
                    });

                    ///////////////////////////
                    var total_hpd = data.plant.hpd.reduce((sum, value) => sum + value, 0);
                    var average_hpd = data.plant.hpd.length > 0 ? total_hpd / data.plant.hpd.length : 0;

                    var total_lpd = data.plant.lpd.reduce((sum, value) => sum + value, 0);
                    var total_bpd = data.plant.bpd.reduce((sum, value) => sum + value, 0);
                    var total_kpd = data.plant.kpd.reduce((sum, value) => sum + value, 0);

                    document.getElementById("hp_total").innerText = Math.round(total_hpd).toLocaleString() + " MW";

                    var totals_powerprods = [total_lpd, total_bpd, total_kpd];
                    var total_sum_powerprods = totals_powerprods.reduce((sum, val) => sum + val, 0);

                    const lpd = data.plant.lpd;
                    const bpd = data.plant.bpd;
                    const kpd = data.plant.kpd;

                    const lpd_pct = [];
                    const bpd_pct = [];
                    const kpd_pct = [];

                    for (let i = 0; i < lpd.length; i++) {
                        lpd_pct.push(lpd[i]);//lpd_pct.push((lpd[i] / total) * 100);
                        bpd_pct.push(bpd[i]);
                        kpd_pct.push(kpd[i]);
                    }

                    line_chart2 = new Chart(document.getElementById(`production_trendchart`).getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: formattedLabels,
                            datasets: [{
                                label: 'Larona',
                                data: lpd_pct,
                                backgroundColor: '#047f7c', 
                                borderColor: '#047f7c',
                                tension: 0.4,
                                pointRadius: 0,
                            },
                            {
                                label: 'Balambano',
                                data: bpd_pct,
                                backgroundColor: '#08bc9d',
                                borderColor: '#08bc9d',
                                tension: 0.4,
                                pointRadius: 0,
                            },
                            {
                                label: 'Karebbe',
                                data: kpd_pct,
                                backgroundColor: '#41b4e0',
                                borderColor: '#41b4e0',
                                tension: 0.4,
                                pointRadius: 0,
                            }]
                        },
                        options: {
                            responsive: false,
                            scales: {
                                x: {
                                    //type: 'time',
                                    time: {
                                        unit: 'minute',
                                        tooltipFormat: 'DD-MM',
                                        displayFormats: { minute: 'DD-MM' }
                                    },
                                    ticks: {
                                        minRotation: 0,
                                        maxTicksLimit: 5,
                                        autoSkip: true,
                                    },
                                    title: {
                                        display: false,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: "MW"
                                    },
                                    // min: 0,
                                    // max: 100
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false,
                                },
                                zoom: zoomPluginsLineConfig
                            },
                        }
                    });
  
                    new Chart(document.getElementById(`production_powerpie1`).getContext('2d'), {
                        type: 'pie',
                        data: {  
                            labels: ['Larona', 'Balambano', 'Karebbe'],
                            datasets: [{
                                data: totals_powerprods,
                                backgroundColor: ['#00807C', '#EEA722', '#41b4e0'],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { font: { size: 10 } }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const value = context.raw;
                                            const percentage = ((value / total_sum_powerprods) * 100).toFixed(1);
                                            return `${value.toFixed(1)} MWh (${percentage}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    formatter: (value, context) => {
                                        const data = context.chart.data.datasets[0].data;
                                        const total = data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return percentage + ' %';
                                    },
                                    color: '#fff',
                                    font: { weight: 'bold', size: 10 }
                                }
                            }
                        },
                        plugins: [{
                            id: 'shadowOnlySlices',
                            beforeDatasetDraw(chart, args, options) {
                                const { ctx } = chart;
                                if (chart.config.type !== 'pie') return;

                                const meta = chart.getDatasetMeta(args.index);
                                meta.data.forEach(segment => {
                                    // Save original draw method
                                    const originalDraw = segment.draw;

                                    // Override draw
                                    segment.draw = function () {
                                        ctx.save();
                                        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                                        ctx.shadowBlur = 10;
                                        ctx.shadowOffsetX = 4;
                                        ctx.shadowOffsetY = 4;

                                        originalDraw.apply(this, arguments);

                                        ctx.restore(); // restore after each slice
                                    };
                                });
                            }
                        }, ChartDataLabels]
                    });

                    var total_aux_0 = data.plant.aux_0.reduce((sum, value) => sum + value, 0);
                    var total_aux_1 = data.plant.aux_1.reduce((sum, value) => sum + value, 0);
                    new Chart(document.getElementById(`grid_pie1`).getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: ['Aux', 'Furnace'],
                            datasets: [{ 
                                data: [total_aux_0, total_aux_1],
                                backgroundColor: ['#00807C', '#EEA722', '#FFC107'],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { font: { size: 10 } }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            const value = context.raw;
                                            const percentage = ((value / total_sum_powerprods) * 100).toFixed(1);
                                            return ` ${value.toFixed(1)} (${percentage}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    formatter: (value, context) => {
                                        const data = context.chart.data.datasets[0].data;
                                        const total = data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return percentage + ' %';
                                    },
                                    color: '#fff',
                                    font: { weight: 'bold', size: 10 }
                                }
                            }
                        },
                        plugins: [{
                            id: 'shadowOnlySlices',
                            beforeDatasetDraw(chart, args, options) {
                                const { ctx } = chart;
                                if (chart.config.type !== 'pie') return;

                                const meta = chart.getDatasetMeta(args.index);
                                meta.data.forEach(segment => {
                                    // Save original draw method
                                    const originalDraw = segment.draw;

                                    // Override draw
                                    segment.draw = function () {
                                        ctx.save();
                                        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                                        ctx.shadowBlur = 10;
                                        ctx.shadowOffsetX = 4;
                                        ctx.shadowOffsetY = 4;

                                        originalDraw.apply(this, arguments);

                                        ctx.restore(); // restore after each slice
                                    };
                                });
                            }
                        }, ChartDataLabels]
                    });

                    line_chart3 = new Chart(document.getElementById(`grid_trendchart`).getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: formattedLabels,
                            datasets: [{
                                label: 'Aux',
                                data: data.plant.aux_0,
                                borderColor: '#00807C',
                                backgroundColor: '#00807C',
                                tension: 0.4,
                                pointRadius: 0,
                            },
                            {
                                label: 'Furnace',
                                data: data.plant.aux_1,
                                borderColor: '#EEA722',
                                backgroundColor: '#EEA722',
                                tension: 0.4,
                                pointRadius: 0,
                            }]
                        },
                        options: {
                            responsive: false,
                            scales: {
                                x: {
                                    //type: 'time',
                                    time: {
                                        unit: 'minute',
                                        tooltipFormat: 'DD-MM',
                                        displayFormats: { minute: 'DD-MM' }
                                    },
                                    ticks: {
                                        minRotation: 0,
                                        maxTicksLimit: 5,
                                        autoSkip: true,
                                    },
                                    title: {
                                        display: false,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: "MW"
                                    },
                                    // min: 0,
                                    // max: 100
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false,
                                },
                                zoom: zoomPluginsLineConfig
                            },
                        }
                    });

                    const noeTitleText = {
                        noe: "Number of Maintenance Events",
                        duration: "Total Maintenance Duration (Hours)",
                    };

                    new Chart(document.getElementById('stackedChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: data.noe.labels,  // Replace with df['Plant'].unique()
                            datasets: [
                                {
                                    label: 'PV & CD',
                                    data: data.noe.data.CD + data.noe.data.PV,  // Replace with category_counts['Electrical'].values.tolist()
                                    backgroundColor: '#007e7a'
                                },
                                {
                                    label: 'CR',
                                    data: data.noe.data.CR,
                                    backgroundColor: '#edb210'
                                },
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Plant'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: noeTitleText[noe_metric]
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });


                    /////////////// LOLOPLSAD{Okas[pdokas]}
                    const kpiProgressContainer = document.getElementById("kpiProgressBarsByMetric");

                    const kpiMetrics = [
                        { key: "oee", label: "OEE", color: "bg-success" },
                        { key: "phy_avail", label: "Physical Availability", color: "bg-info" },
                        { key: "performance", label: "Performance", color: "bg-warning" },
                        { key: "uo_Avail", label: "Utilization of Availability", color: "bg-warning" }
                    ];

                    const lgsUnits = ["lgs1", "lgs2", "lgs3"];


                    kpiMetrics.forEach(metric => {
                        const section = document.createElement("div");
                        section.className = "col-lg-3 col-md-3 col-sm-6 px-0";

                        // <h2>${metric.label}</h2>
                        section.innerHTML = `
                            <div class="x_panel tile" style="height: 30vh;">                
                            <div class="x_content" id="progress_${metric.key}" style="height: 100%;">
                            </div></div>`;

                        const wrapper = section.querySelector(`#progress_${metric.key}`);

                        keys_unit.forEach(unit => {
                            const unitData = data[unit];
                            if (!unitData || !unitData[metric.key]) return;
                            
                            const values = unitData[metric.key].filter(v => Number.isFinite(v));
                            const mean = values.reduce((sum, v) => sum + v, 0) / values.length;
                            const value = Math.round(mean * 100);

                            const bar = document.createElement("div");
                            bar.classList.add("dummy-class");
                            bar.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.2vh;">
                                    <strong style="white-space: nowrap;">${unit.toUpperCase()}</strong>
                                    <div class="progress" style="flex: 1; height: 2.2vh; margin-bottom: 0px; border-radius: 8px;">
                                        <div class="progress-bar ${getColorClassByValue(value, metric.key)}" role="progressbar"
                                            style="width: ${value}%; border-radius: 8px; background-color: ${getColorClassByValue(value, metric.key)}" aria-valuenow="${value}" aria-valuemin="0" aria-valuemax="100"> ${value}%
                                        </div>
                                    </div>
                                </div>`;
                            wrapper.appendChild(bar);
                        });

                        kpiProgressContainer.appendChild(section);
                    });


                }, 500);
            }
        });
    });


    function resetZoom(chart_object) {
        chart_object.resetZoom();
    }

    function openModal() {
        var modal = new bootstrap.Modal(document.getElementById('myModal'));
        modal.show();
    }

    const colors_line_chart1 = ['#007e7a', '#00bc9b', '#3cb5e4', '#f56705'];
    document.getElementById('checkboxContainer').addEventListener('change', function () {
        const checked = Array.from(document.querySelectorAll('input[name="dataset"]:checked'))
            .map(cb => parseInt(cb.value));
        line_chart1.data.datasets = checked.map((i, idx) => ({
            ...kpiDatasets[i],
            borderColor: colors_line_chart1[idx % colors_line_chart1.length],
            backgroundColor: colors_line_chart1[idx % colors_line_chart1.length],
        }));
        line_chart1.update();
    });
    //window.addEventListener('resize', gaugeSeverityChart.resize);
</script>
{% endblock %}